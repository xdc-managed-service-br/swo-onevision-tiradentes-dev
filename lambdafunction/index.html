<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia AWS Lambda Functions - OneVision</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.7;
            color: #2d3748;
            background: linear-gradient(to bottom, #f7fafc, #ffffff);
            padding: 40px 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            border-radius: 16px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 60px 40px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .header .subtitle {
            font-size: 1.3em;
            opacity: 0.95;
            font-weight: 300;
        }
        
        .content {
            padding: 40px;
        }
        
        h2 {
            color: #667eea;
            font-size: 2.2em;
            margin: 40px 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
            position: relative;
        }
        
        h2:before {
            content: '';
            position: absolute;
            left: 0;
            bottom: -3px;
            width: 80px;
            height: 3px;
            background: #764ba2;
        }
        
        h3 {
            color: #4a5568;
            font-size: 1.6em;
            margin: 30px 0 15px 0;
            font-weight: 600;
        }
        
        h4 {
            color: #718096;
            font-size: 1.2em;
            margin: 20px 0 10px 0;
            font-weight: 500;
        }
        
        p {
            margin: 15px 0;
            color: #4a5568;
            text-align: justify;
        }
        
        .highlight-box {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border-left: 4px solid #667eea;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .info-box {
            background: #e6fffa;
            border-left: 4px solid #38b2ac;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .warning-box {
            background: #fffaf0;
            border-left: 4px solid #ed8936;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
        }
        
        .code-container {
            background: #1a202c;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .code-header {
            color: #cbd5e0;
            font-size: 0.9em;
            margin-bottom: 10px;
            font-family: 'JetBrains Mono', monospace;
            opacity: 0.7;
        }
        
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        code {
            font-family: 'JetBrains Mono', 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .code-container code {
            color: #e2e8f0;
        }
        
        /* Syntax highlighting */
        .keyword { color: #f687b3; font-weight: 500; }
        .string { color: #9ae6b4; }
        .comment { color: #718096; font-style: italic; }
        .function { color: #90cdf4; }
        .number { color: #fbd38d; }
        .decorator { color: #fbb6ce; }
        
        .diagram {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }
        
        .flow-diagram {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .flow-item {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 15px 25px;
            margin: 10px;
            font-weight: 500;
            color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
        }
        
        .flow-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }
        
        .arrow {
            font-size: 2em;
            color: #667eea;
            margin: 0 10px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        
        th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        
        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }
        
        tr:hover td {
            background: #f7fafc;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .feature-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s ease;
        }
        
        .feature-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .feature-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }
        
        .feature-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .feature-description {
            color: #718096;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .toc {
            background: #f7fafc;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
        }
        
        .toc h3 {
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .toc ul {
            list-style: none;
            padding-left: 0;
        }
        
        .toc li {
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .toc li:last-child {
            border-bottom: none;
        }
        
        .toc a {
            color: #4a5568;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .toc a:hover {
            color: #667eea;
        }
        
        .badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
            margin: 0 5px;
        }
        
        .badge.success {
            background: #48bb78;
        }
        
        .badge.warning {
            background: #ed8936;
        }
        
        .badge.info {
            background: #4299e1;
        }
        
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .container {
                box-shadow: none;
                border-radius: 0;
            }
            
            .header {
                page-break-after: avoid;
            }
            
            h2 {
                page-break-after: avoid;
            }
            
            .code-container {
                page-break-inside: avoid;
            }
            
            table {
                page-break-inside: avoid;
            }
        }
        
        .page-break {
            page-break-after: always;
        }
        
        .no-break {
            page-break-inside: avoid;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ AWS Lambda Functions</h1>
            <div class="subtitle">Guia Completo para o Projeto OneVision</div>
        </div>
        
        <div class="content">
            <!-- √çndice -->
            <div class="toc">
                <h3>üìö √çndice</h3>
                <ul>
                    <li>1. <a href="#intro">O que √© AWS Lambda?</a></li>
                    <li>2. <a href="#characteristics">Caracter√≠sticas Principais</a></li>
                    <li>3. <a href="#onevision-context">Lambda no Contexto do OneVision</a></li>
                    <li>4. <a href="#flow">Fluxo Completo do Coletor</a></li>
                    <li>5. <a href="#code-explanation">An√°lise Detalhada do C√≥digo</a></li>
                    <li>6. <a href="#dynamodb">Estrutura de Dados no DynamoDB</a></li>
                    <li>7. <a href="#best-practices">Boas Pr√°ticas e Otimiza√ß√µes</a></li>
                    <li>8. <a href="#troubleshooting">Troubleshooting e Monitoramento</a></li>
                </ul>
            </div>

            <!-- Se√ß√£o 1: Introdu√ß√£o -->
            <h2 id="intro">1. O que √© AWS Lambda? ü§î</h2>
            
            <div class="highlight-box">
                <p><strong>Analogia Simples:</strong> Imagine que voc√™ tem um restaurante. Em vez de manter 10 cozinheiros o tempo todo (mesmo quando n√£o h√° clientes), voc√™ contrata cozinheiros apenas quando chegam pedidos. AWS Lambda funciona assim - voc√™ paga apenas quando seu c√≥digo executa!</p>
            </div>

            <p>
                <strong>AWS Lambda</strong> √© um servi√ßo de computa√ß√£o <em>serverless</em> (sem servidor) que executa seu c√≥digo em resposta a eventos. No contexto do <strong>OneVision</strong>, usamos Lambda Functions para coletar informa√ß√µes de recursos AWS de m√∫ltiplas contas de forma autom√°tica e escal√°vel.
            </p>

            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">‚ö°</div>
                    <div class="feature-title">Serverless</div>
                    <div class="feature-description">N√£o precisa gerenciar servidores. AWS cuida de toda infraestrutura.</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üìà</div>
                    <div class="feature-title">Auto-scaling</div>
                    <div class="feature-description">Escala automaticamente de 0 a milhares de execu√ß√µes simult√¢neas.</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üí∞</div>
                    <div class="feature-title">Pay-per-use</div>
                    <div class="feature-description">Paga apenas pelo tempo de execu√ß√£o (por milissegundo).</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">üîó</div>
                    <div class="feature-title">Integra√ß√£o Nativa</div>
                    <div class="feature-description">Integra facilmente com outros servi√ßos AWS (DynamoDB, S3, etc.).</div>
                </div>
            </div>

            <!-- Se√ß√£o 2: Caracter√≠sticas -->
            <h2 id="characteristics">2. Caracter√≠sticas Principais do Lambda</h2>

            <h3>2.1 Modelo de Execu√ß√£o</h3>
            <p>
                Lambda Functions s√£o executadas em <strong>containers ef√™meros</strong> - containers tempor√°rios que s√£o criados quando necess√°rio e destru√≠dos ap√≥s a execu√ß√£o. Isso significa que:
            </p>

            <table>
                <thead>
                    <tr>
                        <th>Caracter√≠stica</th>
                        <th>Descri√ß√£o</th>
                        <th>Impacto no OneVision</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Stateless</strong></td>
                        <td>N√£o mant√©m estado entre execu√ß√µes</td>
                        <td>Cada coleta √© independente</td>
                    </tr>
                    <tr>
                        <td><strong>Timeout</strong></td>
                        <td>M√°ximo 15 minutos de execu√ß√£o</td>
                        <td>Coletores devem ser eficientes</td>
                    </tr>
                    <tr>
                        <td><strong>Mem√≥ria</strong></td>
                        <td>128 MB a 10 GB</td>
                        <td>Configuramos 3 GB para processar grandes volumes</td>
                    </tr>
                    <tr>
                        <td><strong>Concorr√™ncia</strong></td>
                        <td>At√© 1000 execu√ß√µes simult√¢neas</td>
                        <td>M√∫ltiplas contas/regi√µes em paralelo</td>
                    </tr>
                </tbody>
            </table>

            <h3>2.2 Triggers (Gatilhos)</h3>
            <p>No OneVision, as Lambda Functions s√£o acionadas por:</p>
            
            <div class="info-box">
                <p><strong>EventBridge Schedule:</strong> Execu√ß√£o programada a cada 24 horas para coletar dados atualizados de todas as contas AWS.</p>
            </div>

            <!-- Se√ß√£o 3: Contexto OneVision -->
            <h2 id="onevision-context">3. Lambda no Contexto do OneVision</h2>

            <div class="diagram">
                <h3>Arquitetura do OneVision</h3>
                <div class="flow-diagram">
                    <div class="flow-item">üè¢ M√∫ltiplas Contas AWS</div>
                    <span class="arrow">‚Üí</span>
                    <div class="flow-item">‚ö° Lambda Functions</div>
                    <span class="arrow">‚Üí</span>
                    <div class="flow-item">üíæ DynamoDB</div>
                    <span class="arrow">‚Üí</span>
                    <div class="flow-item">üìä Dashboard</div>
                </div>
            </div>

            <h3>3.1 Por que Lambda para o OneVision?</h3>
            
            <p>A escolha do Lambda para o OneVision foi estrat√©gica:</p>
            
            <ul style="margin: 20px 0; padding-left: 30px;">
                <li><strong>Custo-efetivo:</strong> Executamos apenas quando precisamos coletar dados (a cada 24 horas)</li>
                <li><strong>Escalabilidade:</strong> Processa m√∫ltiplas contas e regi√µes em paralelo</li>
                <li><strong>Manuten√ß√£o zero:</strong> N√£o precisamos gerenciar servidores</li>
                <li><strong>Seguran√ßa:</strong> Executa com IAM roles tempor√°rios (AssumeRole)</li>
                <li><strong>Integra√ß√£o nativa:</strong> Conecta diretamente com DynamoDB e outros servi√ßos AWS</li>
            </ul>

            <h3>3.2 Fluxo de Permiss√µes</h3>
            
            <div class="warning-box">
                <p><strong>Importante:</strong> As Lambda Functions do OneVision usam o padr√£o <strong>AssumeRole</strong> para acessar recursos em outras contas de forma segura e tempor√°ria.</p>
            </div>

            <div class="code-container">
                <div class="code-header"># Processo de AssumeRole</div>
                <pre><code><span class="comment"># 1. Lambda tem uma role de execu√ß√£o (OneVisionDataCollectorRole)</span>
<span class="comment"># 2. Essa role tem permiss√£o para assumir OneVisionDataCollectorRole em outras contas</span>
<span class="comment"># 3. OneVisionDataCollectorRole tem permiss√µes ReadOnly para a maioria do servi√ßos</span>

<span class="keyword">def</span> <span class="function">assume_role_in_account</span>(account_id):
    sts = boto3.client(<span class="string">'sts'</span>)
    
    <span class="comment"># Assume a role na conta destino</span>
    response = sts.assume_role(
        RoleArn=<span class="string">f'arn:aws:iam::</span>{account_id}<span class="string">:role/OneVisionDataCollectorRole'</span>,
        RoleSessionName=<span class="string">'OneVisionCollector'</span>,
        DurationSeconds=<span class="number">3600</span>  <span class="comment"># Credenciais tempor√°rias por 1 hora</span>
    )
    
    <span class="keyword">return</span> response[<span class="string">'Credentials'</span>]</code></pre>
            </div>

            <!-- Se√ß√£o 4: Fluxo do Coletor -->
            <div class="page-break"></div>
            
            <h2 id="flow">4. Fluxo Completo do Coletor üîÑ</h2>

            <div class="highlight-box">
                <p><strong>Vis√£o Geral:</strong> O processo de coleta √© como um "censo" automatizado que visita cada conta AWS, conta os recursos, anota suas caracter√≠sticas e armazena tudo em um banco de dados central.</p>
            </div>

            <h3>4.1 Fluxo Detalhado Passo a Passo</h3>

            <div class="diagram">
                <svg width="100%" height="600" viewBox="0 0 800 600">
                    <!-- Background -->
                    <rect width="800" height="600" fill="#f7fafc" rx="10"/>
                    
                    <!-- Title -->
                    <text x="400" y="30" text-anchor="middle" font-size="20" font-weight="bold" fill="#2d3748">
                        Fluxo de Execu√ß√£o da Lambda do OneVision
                    </text>
                    
                    <!-- Step 1 -->
                    <rect x="50" y="60" width="200" height="80" rx="10" fill="#667eea" opacity="0.9"/>
                    <text x="150" y="90" text-anchor="middle" fill="white" font-weight="500">1. EventBridge</text>
                    <text x="150" y="110" text-anchor="middle" fill="white" font-size="14">Dispara a cada 24h</text>
                    <text x="150" y="130" text-anchor="middle" fill="white" font-size="14">ou manualmente</text>
                    
                    <!-- Arrow 1 -->
                    <path d="M 250 100 L 300 100" stroke="#667eea" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Step 2 -->
                    <rect x="300" y="60" width="200" height="80" rx="10" fill="#764ba2" opacity="0.9"/>
                    <text x="400" y="90" text-anchor="middle" fill="white" font-weight="500">2. Lambda Inicia</text>
                    <text x="400" y="110" text-anchor="middle" fill="white" font-size="14">Lista contas da</text>
                    <text x="400" y="130" text-anchor="middle" fill="white" font-size="14">Organizations</text>
                    
                    <!-- Arrow 2 -->
                    <path d="M 500 100 L 550 100" stroke="#764ba2" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Step 3 -->
                    <rect x="550" y="60" width="200" height="80" rx="10" fill="#667eea" opacity="0.9"/>
                    <text x="650" y="90" text-anchor="middle" fill="white" font-weight="500">3. Para cada conta</text>
                    <text x="650" y="110" text-anchor="middle" fill="white" font-size="14">AssumeRole</text>
                    <text x="650" y="130" text-anchor="middle" fill="white" font-size="14">(OneVisionDataCollectorRole)</text>
                    
                    <!-- Arrow 3 (curved down) -->
                    <path d="M 650 140 Q 650 180 650 200" stroke="#667eea" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Step 4 -->
                    <rect x="550" y="200" width="200" height="80" rx="10" fill="#764ba2" opacity="0.9"/>
                    <text x="650" y="230" text-anchor="middle" fill="white" font-weight="500">4. Lista Regi√µes</text>
                    <text x="650" y="250" text-anchor="middle" fill="white" font-size="14">Descobre regi√µes</text>
                    <text x="650" y="270" text-anchor="middle" fill="white" font-size="14">habilitadas</text>
                    
                    <!-- Arrow 4 (curved left) -->
                    <path d="M 550 240 Q 500 240 450 240" stroke="#764ba2" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Step 5 -->
                    <rect x="250" y="200" width="200" height="80" rx="10" fill="#667eea" opacity="0.9"/>
                    <text x="350" y="230" text-anchor="middle" fill="white" font-weight="500">5. Coleta Paralela</text>
                    <text x="350" y="250" text-anchor="middle" fill="white" font-size="14">ThreadPoolExecutor</text>
                    <text x="350" y="270" text-anchor="middle" fill="white" font-size="14">Max 10 workers</text>
                    
                    <!-- Arrow 5 (down) -->
                    <path d="M 350 280 L 350 330" stroke="#667eea" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- Step 6 (Multiple collectors) -->
                    <g>
                        <rect x="50" y="330" width="140" height="60" rx="8" fill="#38b2ac" opacity="0.9"/>
                        <text x="120" y="355" text-anchor="middle" fill="white" font-size="14">ComputeCollector</text>
                        <text x="120" y="375" text-anchor="middle" fill="white" font-size="12">Instances, AMIs</text>
                    </g>
                    
                    <g>
                        <rect x="210" y="330" width="140" height="60" rx="8" fill="#38b2ac" opacity="0.9"/>
                        <text x="280" y="355" text-anchor="middle" fill="white" font-size="14">StorageCollector</text>
                        <text x="280" y="375" text-anchor="middle" fill="white" font-size="12">S3, EBS, EFS</text>
                    </g>
                    
                    <g>
                        <rect x="370" y="330" width="140" height="60" rx="8" fill="#38b2ac" opacity="0.9"/>
                        <text x="440" y="355" text-anchor="middle" fill="white" font-size="14">DatabaseCollector</text>
                        <text x="440" y="375" text-anchor="middle" fill="white" font-size="12">Databases</text>
                    </g>
                    
                    <g>
                        <rect x="530" y="330" width="140" height="60" rx="8" fill="#38b2ac" opacity="0.9"/>
                        <text x="600" y="355" text-anchor="middle" fill="white" font-size="14">NetworkCollector</text>
                        <text x="600" y="375" text-anchor="middle" fill="white" font-size="12">VPC, SG, ELB</text>
                    </g>
                    
                    <!-- Arrows from collectors -->
                    <path d="M 120 390 Q 350 430 350 450" stroke="#38b2ac" stroke-width="2" marker-end="url(#arrowhead2)"/>
                    <path d="M 280 390 Q 350 420 350 450" stroke="#38b2ac" stroke-width="2" marker-end="url(#arrowhead2)"/>
                    <path d="M 440 390 Q 350 420 350 450" stroke="#38b2ac" stroke-width="2" marker-end="url(#arrowhead2)"/>
                    <path d="M 600 390 Q 350 430 350 450" stroke="#38b2ac" stroke-width="2" marker-end="url(#arrowhead2)"/>
                    
                    <!-- Step 7 -->
                    <rect x="250" y="450" width="200" height="80" rx="10" fill="#764ba2" opacity="0.9"/>
                    <text x="350" y="480" text-anchor="middle" fill="white" font-weight="500">7. Batch Write</text>
                    <text x="350" y="500" text-anchor="middle" fill="white" font-size="14">DynamoDB Tables</text>
                    <text x="350" y="520" text-anchor="middle" fill="white" font-size="14">25 items/batch</text>
                    
                    <!-- Arrow to DynamoDB -->
                    <path d="M 450 490 L 530 490" stroke="#764ba2" stroke-width="3" marker-end="url(#arrowhead)"/>
                    
                    <!-- DynamoDB -->
                    <rect x="530" y="450" width="200" height="80" rx="10" fill="#48bb78" opacity="0.9"/>
                    <text x="630" y="480" text-anchor="middle" fill="white" font-weight="500">DynamoDB</text>
                    <text x="630" y="500" text-anchor="middle" fill="white" font-size="14">AWSResource</text>
                    <text x="630" y="520" text-anchor="middle" fill="white" font-size="14">AWSMetrics</text>
                    
                    <!-- Arrow markers -->
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#667eea"/>
                        </marker>
                        <marker id="arrowhead2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                            <polygon points="0 0, 10 3, 0 6" fill="#38b2ac"/>
                        </marker>
                    </defs>
                </svg>
            </div>

            <h3>4.2 Detalhamento de Cada Etapa</h3>

            <h4>üïê Etapa 1: Trigger (EventBridge)</h4>
            <div class="info-box">
                <p>O EventBridge executa a Lambda com uma regra CRON: <code>rate(24 hours)</code></p>
                <p>Isso garante que os dados estejam sempre atualizados no dashboard.</p>
            </div>

            <h4>üöÄ Etapa 2: Inicializa√ß√£o da Lambda</h4>
            <div class="code-container">
                <div class="code-header"># In√≠cio da execu√ß√£o</div>
                <pre><code><span class="keyword">def</span> <span class="function">lambda_handler</span>(event, context):
    <span class="comment"># Context fornece informa√ß√µes sobre a execu√ß√£o</span>
    logger.info(<span class="string">f"Tempo restante: </span>{context.get_remaining_time_in_millis()}<span class="string"> ms"</span>)
    
    <span class="comment"># Lista todas as contas da organiza√ß√£o</span>
    accounts = get_all_organization_accounts()
    <span class="comment"># Retorna: [('123456789', 'Conta Produ√ß√£o'), ('987654321', 'Conta Dev'), ...]</span></code></pre>
            </div>

            <h4>üîë Etapa 3: AssumeRole</h4>
            <p>Para cada conta, assumimos a role <code>OneVisionDataCollectorRole</code> que foi previamente configurada com permiss√µes de leitura:</p>

            <div class="code-container">
                <div class="code-header"># Assumindo role em cada conta</div>
                <pre><code><span class="keyword">for</span> account_id, account_name <span class="keyword">in</span> accounts:
    <span class="keyword">try</span>:
        <span class="comment"># Obt√©m credenciais tempor√°rias</span>
        credentials = assume_role(account_id)
        <span class="comment"># credentials cont√©m: AccessKeyId, SecretAccessKey, SessionToken</span>
        
        <span class="comment"># Usa as credenciais para criar clients AWS</span>
        ec2_client = boto3.client(<span class="string">'ec2'</span>,
            aws_access_key_id=credentials[<span class="string">'AccessKeyId'</span>],
            aws_secret_access_key=credentials[<span class="string">'SecretAccessKey'</span>],
            aws_session_token=credentials[<span class="string">'SessionToken'</span>]
        )</code></pre>
            </div>

            <h4>üåç Etapa 4: Descoberta de Regi√µes</h4>
            <div class="warning-box">
                <p><strong>Otimiza√ß√£o:</strong> S√≥ coletamos dados de regi√µes habilitadas na conta para evitar erros e reduzir tempo de execu√ß√£o.</p>
            </div>

            <h4>‚ö° Etapa 5: Coleta Paralela</h4>
            <p>Usamos <strong>ThreadPoolExecutor</strong> para processar m√∫ltiplas regi√µes simultaneamente:</p>

            <div class="code-container">
                <div class="code-header"># Processamento paralelo de regi√µes</div>
                <pre><code><span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">10</span>) <span class="keyword">as</span> executor:
    futures = []
    <span class="keyword">for</span> region <span class="keyword">in</span> regions:
        <span class="comment"># Submete cada regi√£o para processamento paralelo</span>
        future = executor.submit(process_region, account_id, region, credentials)
        futures.append(future)
    
    <span class="comment"># Aguarda conclus√£o e coleta resultados</span>
    <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(futures):
        result = future.result()</code></pre>
            </div>

            <!-- Se√ß√£o 5: An√°lise do C√≥digo -->
            <div class="page-break"></div>

            <h2 id="code-explanation">5. An√°lise Detalhada do C√≥digo üìù</h2>

            <h3>5.1 Estrutura do Projeto</h3>
            
            <div class="code-container">
                <div class="code-header"># Estrutura de diret√≥rios</div>
                <pre><code>lambdafunction/
‚îú‚îÄ‚îÄ index.py                    <span class="comment"># Entry point da Lambda</span>
‚îú‚îÄ‚îÄ collectors/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ base.py                 <span class="comment"># Classe base ResourceCollector</span>
‚îÇ   ‚îú‚îÄ‚îÄ compute_collector.py        <span class="comment"># Coleta EC2, EBS, AMIs</span>
‚îÇ   ‚îú‚îÄ‚îÄ storage_collector.py    <span class="comment"># Coleta S3, EFS, FSx</span>
‚îÇ   ‚îú‚îÄ‚îÄ database_collector.py        <span class="comment"># Coleta RDS</span>
‚îÇ   ‚îú‚îÄ‚îÄ networking_collector.py <span class="comment"># Coleta VPC, SecurityGroups</span>
‚îÇ   ‚îî‚îÄ‚îÄ metrics_calculator.py   <span class="comment"># Calcula m√©tricas agregadas</span></code></pre>
            </div>

            <h3>5.2 An√°lise Linha por Linha: ComputeCollector</h3>

            <div class="highlight-box">
                <p><strong>Vamos analisar o ComputeCollector como exemplo</strong>, pois ele demonstra todos os padr√µes usados nos outros coletores.</p>
            </div>

            <div class="code-container">
                <div class="code-header">ec2_collector.py - An√°lise detalhada</div>
                <pre><code><span class="decorator">@dataclass</span>
<span class="keyword">class</span> <span class="function">ComputeCollector</span>(ResourceCollector):
    <span class="string">"""
    Collector respons√°vel por coletar informa√ß√µes de EC2.
    Herda de ResourceCollector que fornece m√©todos comuns.
    """</span>
    
    <span class="keyword">def</span> <span class="function">collect</span>(self):
        <span class="string">"""M√©todo principal de coleta - orquestra todo o processo"""</span>
        
        <span class="comment"># 1. Cria cliente EC2 com as credenciais assumidas</span>
        ec2 = self.get_client(<span class="string">'ec2'</span>)
        <span class="comment"># get_client() usa as credenciais tempor√°rias do AssumeRole</span>
        
        <span class="comment"># 2. Cria cliente CloudWatch para m√©tricas</span>
        cloudwatch = self.get_client(<span class="string">'cloudwatch'</span>)
        
        <span class="comment"># 3. Chama m√©todos espec√≠ficos para cada tipo de recurso</span>
        self._collect_instances(ec2, cloudwatch)  <span class="comment"># EC2 instances</span>
        self._collect_volumes(ec2)                <span class="comment"># EBS volumes</span>
        self._collect_snapshots(ec2)              <span class="comment"># EBS snapshots</span>
        self._collect_amis(ec2)                   <span class="comment"># AMIs</span>
        
        <span class="keyword">return</span> self.items  <span class="comment"># Lista de todos os recursos coletados</span>
    
    <span class="keyword">def</span> <span class="function">_collect_instances</span>(self, ec2, cloudwatch):
        <span class="string">"""Coleta informa√ß√µes detalhadas de inst√¢ncias EC2"""</span>
        
        <span class="comment"># 1. Usa pagina√ß√£o para lidar com muitas inst√¢ncias</span>
        paginator = ec2.get_paginator(<span class="string">'describe_instances'</span>)
        <span class="comment"># Pagina√ß√£o √© CRUCIAL - contas podem ter milhares de inst√¢ncias</span>
        
        <span class="keyword">for</span> page <span class="keyword">in</span> paginator.paginate(PaginationConfig={<span class="string">'PageSize'</span>: <span class="number">100</span>}):
            <span class="comment"># PageSize=100 balanceia mem√≥ria vs n√∫mero de chamadas API</span>
            
            <span class="keyword">for</span> reservation <span class="keyword">in</span> page.get(<span class="string">'Reservations'</span>, []):
                <span class="keyword">for</span> instance <span class="keyword">in</span> reservation.get(<span class="string">'Instances'</span>, []):
                    <span class="comment"># 2. Extrai informa√ß√µes b√°sicas</span>
                    instance_id = instance[<span class="string">'InstanceId'</span>]
                    state = instance.get(<span class="string">'State'</span>, {}).get(<span class="string">'Name'</span>, <span class="string">'unknown'</span>)
                    
                    <span class="comment"># 3. Processa tags (muito importante no OneVision!)</span>
                    tags = instance.get(<span class="string">'Tags'</span>, [])
                    tags_dict = {tag[<span class="string">'Key'</span>]: tag[<span class="string">'Value'</span>] <span class="keyword">for</span> tag <span class="keyword">in</span> tags}
                    
                    <span class="comment"># 4. Tags especiais do OneVision</span>
                    instance_name = tags_dict.get(<span class="string">'Name'</span>, <span class="string">'N/A'</span>)
                    swo_backup = tags_dict.get(<span class="string">'swoBackup'</span>)     <span class="comment"># Config backup</span>
                    swo_patch = tags_dict.get(<span class="string">'swoPatch'</span>)       <span class="comment"># Config patch</span>
                    swo_monitor = tags_dict.get(<span class="string">'swoMonitor'</span>)   <span class="comment"># Config monitoramento</span>
                    
                    <span class="comment"># 5. Detec√ß√£o do CloudWatch Agent (s√≥ para running)</span>
                    cw_agent_detected = <span class="keyword">False</span>
                    <span class="keyword">if</span> state == <span class="string">'running'</span>:
                        cw_agent_detected = self._check_cw_agent(
                            cloudwatch, instance_id
                        )
                    
                    <span class="comment"># 6. Monta objeto para salvar</span>
                    item = {
                        <span class="string">'instanceId'</span>: instance_id,
                        <span class="string">'instanceName'</span>: instance_name,
                        <span class="string">'instanceType'</span>: instance.get(<span class="string">'InstanceType'</span>),
                        <span class="string">'instanceState'</span>: state,
                        <span class="string">'region'</span>: self.region,
                        <span class="string">'accountId'</span>: self.account_id,
                        <span class="string">'accountName'</span>: self.account_name,
                        <span class="string">'tags'</span>: json.dumps(tags),  <span class="comment"># Tags como JSON string</span>
                        <span class="string">'swoBackup'</span>: swo_backup,
                        <span class="string">'swoPatch'</span>: swo_patch,
                        <span class="string">'swoMonitor'</span>: swo_monitor,
                        <span class="string">'cwAgentDetected'</span>: cw_agent_detected,
                        <span class="string">'createdAt'</span>: datetime.now(timezone.utc).isoformat(),
                        <span class="string">'updatedAt'</span>: datetime.now(timezone.utc).isoformat()
                    }
                    
                    <span class="comment"># 7. Adiciona √† lista de items para batch write</span>
                    self.add_item(<span class="string">'EC2Instance'</span>, instance_id, item)
    
    <span class="keyword">def</span> <span class="function">_check_cw_agent</span>(self, cloudwatch, instance_id):
        <span class="string">"""Verifica se CloudWatch Agent est√° instalado"""</span>
        <span class="keyword">try</span>:
            <span class="comment"># Busca m√©tricas espec√≠ficas do CW Agent</span>
            response = cloudwatch.list_metrics(
                Namespace=<span class="string">'CWAgent'</span>,
                Dimensions=[
                    {<span class="string">'Name'</span>: <span class="string">'InstanceId'</span>, <span class="string">'Value'</span>: instance_id}
                ]
            )
            <span class="comment"># Se existem m√©tricas, o agent est√° instalado</span>
            <span class="keyword">return</span> len(response.get(<span class="string">'Metrics'</span>, [])) > <span class="number">0</span>
        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:
            logger.warning(<span class="string">f"Erro verificando CW Agent: </span>{e}<span class="string">"</span>)
            <span class="keyword">return</span> <span class="keyword">False</span></code></pre>
            </div>

            <h3>5.3 Batch Write para DynamoDB</h3>

            <div class="info-box">
                <p><strong>Por que Batch Write?</strong> DynamoDB cobra por opera√ß√£o de escrita. Enviar items em lote (at√© 25 por vez) √© muito mais eficiente e barato que enviar um por um.</p>
            </div>

            <div class="code-container">
                <div class="code-header"># Batch write otimizado</div>
                <pre><code><span class="keyword">def</span> <span class="function">batch_write_to_dynamodb</span>(table, items):
    <span class="string">"""
    Escreve items em lote no DynamoDB com retry autom√°tico.
    DynamoDB permite m√°ximo 25 items por batch.
    """</span>
    
    <span class="comment"># Divide items em chunks de 25</span>
    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>, len(items), <span class="number">25</span>):
        batch = items[i:i+<span class="number">25</span>]
        
        <span class="comment"># Prepara request no formato do DynamoDB</span>
        request_items = {
            table.name: [
                {<span class="string">'PutRequest'</span>: {<span class="string">'Item'</span>: item}} 
                <span class="keyword">for</span> item <span class="keyword">in</span> batch
            ]
        }
        
        <span class="comment"># Implementa retry com backoff exponencial</span>
        retries = <span class="number">0</span>
        max_retries = <span class="number">5</span>
        
        <span class="keyword">while</span> retries < max_retries:
            <span class="keyword">try</span>:
                response = table.meta.client.batch_write_item(
                    RequestItems=request_items
                )
                
                <span class="comment"># Verifica se h√° items n√£o processados</span>
                unprocessed = response.get(<span class="string">'UnprocessedItems'</span>, {})
                <span class="keyword">if</span> <span class="keyword">not</span> unprocessed:
                    <span class="keyword">break</span>  <span class="comment"># Sucesso!</span>
                
                <span class="comment"># Se h√° items n√£o processados, retry apenas esses</span>
                request_items = unprocessed
                retries += <span class="number">1</span>
                time.sleep(<span class="number">2</span> ** retries)  <span class="comment"># Backoff exponencial</span>
                
            <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:
                <span class="keyword">if</span> e.response[<span class="string">'Error'</span>][<span class="string">'Code'</span>] == <span class="string">'ProvisionedThroughputExceededException'</span>:
                    <span class="comment"># Throttling - aguarda e tenta novamente</span>
                    retries += <span class="number">1</span>
                    time.sleep(<span class="number">2</span> ** retries)
                <span class="keyword">else</span>:
                    <span class="keyword">raise</span></code></pre>
            </div>

            <!-- Se√ß√£o 6: DynamoDB -->
            <div class="page-break"></div>

            <h2 id="dynamodb">6. Estrutura de Dados no DynamoDB üíæ</h2>

            <h3>6.1 Tabela AWSResource</h3>
            
            <p>Armazena todos os recursos AWS coletados. Vamos analisar cada campo usando exemplos reais:</p>

            <div class="highlight-box">
                <p><strong>Exemplo Real:</strong> Uma inst√¢ncia EC2 coletada do ambiente de produ√ß√£o</p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Campo</th>
                        <th>Tipo</th>
                        <th>Exemplo</th>
                        <th>Descri√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>id</strong> <span class="badge">PK</span></td>
                        <td>String</td>
                        <td>058264393294-us-east-1-EC2Instance-i-0c667f5e46fa4348a</td>
                        <td>Chave prim√°ria √∫nica: {accountId}-{region}-{resourceType}-{resourceId}</td>
                    </tr>
                    <tr>
                        <td><strong>accountId</strong></td>
                        <td>String</td>
                        <td>058264393294</td>
                        <td>ID da conta AWS (12 d√≠gitos)</td>
                    </tr>
                    <tr>
                        <td><strong>accountName</strong></td>
                        <td>String</td>
                        <td>CustomAccount</td>
                        <td>Nome amig√°vel da conta</td>
                    </tr>
                    <tr>
                        <td><strong>resourceType</strong></td>
                        <td>String</td>
                        <td>EC2Instance</td>
                        <td>Tipo do recurso (EC2Instance, S3Bucket, etc)</td>
                    </tr>
                    <tr>
                        <td><strong>region</strong></td>
                        <td>String</td>
                        <td>us-east-1</td>
                        <td>Regi√£o AWS onde o recurso est√°</td>
                    </tr>
                    <tr>
                        <td><strong>instanceId</strong></td>
                        <td>String</td>
                        <td>i-0c667f5e46fa4348a</td>
                        <td>ID √∫nico da inst√¢ncia EC2</td>
                    </tr>
                    <tr>
                        <td><strong>instanceName</strong></td>
                        <td>String</td>
                        <td>aws-teltec-zabbix</td>
                        <td>Nome da inst√¢ncia (tag Name)</td>
                    </tr>
                    <tr>
                        <td><strong>instanceType</strong></td>
                        <td>String</td>
                        <td>m6a.large</td>
                        <td>Tipo/tamanho da inst√¢ncia</td>
                    </tr>
                    <tr>
                        <td><strong>instanceState</strong></td>
                        <td>String</td>
                        <td>running</td>
                        <td>Estado atual (running, stopped, terminated)</td>
                    </tr>
                    <tr>
                        <td><strong>platformDetails</strong></td>
                        <td>String</td>
                        <td>Linux/UNIX</td>
                        <td>Sistema operacional</td>
                    </tr>
                    <tr>
                        <td><strong>tags</strong></td>
                        <td>JSON String</td>
                        <td>[{"Key": "Name", "Value": "aws-teltec-zabbix"}, {"Key": "swoBackup", "Value": "2"}]</td>
                        <td>Todas as tags AWS em formato JSON</td>
                    </tr>
                    <tr>
                        <td><strong>swoBackup</strong></td>
                        <td>String</td>
                        <td>2</td>
                        <td>N√≠vel de backup (0=sem, 1=di√°rio, 2=hora em hora)</td>
                    </tr>
                    <tr>
                        <td><strong>swoPatch</strong></td>
                        <td>String</td>
                        <td>1</td>
                        <td>Habilitado para patching autom√°tico (1=sim, 0=n√£o)</td>
                    </tr>
                    <tr>
                        <td><strong>swoMonitor</strong></td>
                        <td>String</td>
                        <td>1</td>
                        <td>Monitoramento habilitado (1=sim, 0=n√£o)</td>
                    </tr>
                    <tr>
                        <td><strong>swoRiskClass</strong></td>
                        <td>String</td>
                        <td>1</td>
                        <td>Classifica√ß√£o de risco (1=cr√≠tico, 2=alto, 3=m√©dio, 4=baixo)</td>
                    </tr>
                    <tr>
                        <td><strong>patchGroup</strong></td>
                        <td>String</td>
                        <td>1</td>
                        <td>Grupo de patching (define janela de manuten√ß√£o)</td>
                    </tr>
                    <tr>
                        <td><strong>cwAgentMemoryDetected</strong></td>
                        <td>Boolean</td>
                        <td>true</td>
                        <td>CloudWatch Agent coletando mem√≥ria</td>
                    </tr>
                    <tr>
                        <td><strong>cwAgentDiskDetected</strong></td>
                        <td>Boolean</td>
                        <td>true</td>
                        <td>CloudWatch Agent coletando disco</td>
                    </tr>
                    <tr>
                        <td><strong>ssmStatus</strong></td>
                        <td>String</td>
                        <td>Online</td>
                        <td>Status do Systems Manager Agent</td>
                    </tr>
                    <tr>
                        <td><strong>ssmVersion</strong></td>
                        <td>String</td>
                        <td>3.3.3050.0</td>
                        <td>Vers√£o do SSM Agent</td>
                    </tr>
                    <tr>
                        <td><strong>ssmLastPingTime</strong></td>
                        <td>String</td>
                        <td>2025-09-14T20:43:34.942Z</td>
                        <td>√öltima comunica√ß√£o com SSM</td>
                    </tr>
                    <tr>
                        <td><strong>healthStatus</strong></td>
                        <td>String</td>
                        <td>Healthy</td>
                        <td>Status de sa√∫de agregado</td>
                    </tr>
                    <tr>
                        <td><strong>healthChecksPassed</strong></td>
                        <td>Number</td>
                        <td>3</td>
                        <td>Checks de sa√∫de passados</td>
                    </tr>
                    <tr>
                        <td><strong>healthChecksTotal</strong></td>
                        <td>Number</td>
                        <td>3</td>
                        <td>Total de checks de sa√∫de</td>
                    </tr>
                    <tr>
                        <td><strong>instancePrivateIps</strong></td>
                        <td>List</td>
                        <td>["172.24.81.66", "172.24.81.8"]</td>
                        <td>IPs privados da inst√¢ncia</td>
                    </tr>
                    <tr>
                        <td><strong>instancePublicIps</strong></td>
                        <td>List</td>
                        <td>[]</td>
                        <td>IPs p√∫blicos (vazio se n√£o tiver)</td>
                    </tr>
                    <tr>
                        <td><strong>createdAt</strong></td>
                        <td>String</td>
                        <td>2025-08-23T05:58:11.000Z</td>
                        <td>Quando o recurso foi criado na AWS</td>
                    </tr>
                    <tr>
                        <td><strong>updatedAt</strong></td>
                        <td>String</td>
                        <td>2025-09-14T20:46:24.205Z</td>
                        <td>√öltima atualiza√ß√£o no DynamoDB</td>
                    </tr>
                </tbody>
            </table>

            <h3>6.2 Outros Tipos de Recursos</h3>

            <h4>S3 Bucket</h4>
            <div class="code-container">
                <div class="code-header"># Exemplo: S3 Bucket</div>
                <pre><code>{
  <span class="string">"id"</span>: <span class="string">"590183843163-us-east-1-S3Bucket-my-application-logs"</span>,
  <span class="string">"resourceType"</span>: <span class="string">"S3Bucket"</span>,
  <span class="string">"bucketName"</span>: <span class="string">"my-application-logs"</span>,
  <span class="string">"encryption"</span>: <span class="string">"AES256"</span>,           <span class="comment">// Tipo de criptografia</span>
  <span class="string">"versioning"</span>: <span class="string">"Enabled"</span>,           <span class="comment">// Versionamento habilitado</span>
  <span class="string">"hasLifecycleRules"</span>: <span class="keyword">true</span>,        <span class="comment">// Tem regras de ciclo de vida</span>
  <span class="string">"publicAccessBlock"</span>: <span class="keyword">true</span>,        <span class="comment">// Bloqueio de acesso p√∫blico</span>
  <span class="string">"metrics"</span>: {
    <span class="string">"objectCount"</span>: <span class="number">15234</span>,           <span class="comment">// N√∫mero de objetos</span>
    <span class="string">"storageBytes_Standard"</span>: <span class="string">"1.5 TB"</span>, <span class="comment">// Tamanho em Standard</span>
    <span class="string">"storageBytes_Glacier"</span>: <span class="string">"500 GB"</span>  <span class="comment">// Tamanho em Glacier</span>
  }
}</code></pre>
            </div>

            <h4>RDS Instance</h4>
            <div class="code-container">
                <div class="code-header"># Exemplo: RDS Database</div>
                <pre><code>{
  <span class="string">"id"</span>: <span class="string">"905418331872-us-east-1-RDSInstance-database-production"</span>,
  <span class="string">"resourceType"</span>: <span class="string">"RDSInstance"</span>,
  <span class="string">"dbInstanceId"</span>: <span class="string">"database-production"</span>,
  <span class="string">"engine"</span>: <span class="string">"aurora-mysql"</span>,        <span class="comment">// Tipo de banco</span>
  <span class="string">"engineVersion"</span>: <span class="string">"8.0.mysql_aurora.3.08.2"</span>,
  <span class="string">"instanceClass"</span>: <span class="string">"db.t3.medium"</span>,   <span class="comment">// Tamanho da inst√¢ncia</span>
  <span class="string">"multiAZ"</span>: <span class="keyword">false</span>,                  <span class="comment">// Multi-AZ para HA</span>
  <span class="string">"performanceInsightsEnabled"</span>: <span class="keyword">false</span>, <span class="comment">// Performance Insights</span>
  <span class="string">"allocatedStorage"</span>: <span class="number">100</span>,           <span class="comment">// Armazenamento em GB</span>
  <span class="string">"status"</span>: <span class="string">"available"</span>              <span class="comment">// Status do banco</span>
}</code></pre>
            </div>

            <h3>6.3 Tabela AWSMetrics</h3>

            <p>Armazena m√©tricas agregadas calculadas ap√≥s cada coleta:</p>

            <div class="code-container">
                <div class="code-header"># Exemplo: M√©tricas Agregadas</div>
                <pre><code>{
  <span class="string">"id"</span>: <span class="string">"METRICS-EC2-CURRENT"</span>,       <span class="comment">// ID fixo para √∫ltima m√©trica</span>
  <span class="string">"resourceType"</span>: <span class="string">"METRIC-EC2-HEALTH"</span>,
  <span class="string">"metricDate"</span>: <span class="string">"2025-09-15"</span>,
  
  <span class="comment">// Estat√≠sticas de EC2</span>
  <span class="string">"total"</span>: <span class="number">38</span>,                       <span class="comment">// Total de inst√¢ncias</span>
  <span class="string">"byState_running"</span>: <span class="number">36</span>,             <span class="comment">// Inst√¢ncias rodando</span>
  <span class="string">"byState_stopped"</span>: <span class="number">2</span>,              <span class="comment">// Inst√¢ncias paradas</span>
  
  <span class="comment">// CloudWatch Agent</span>
  <span class="string">"cloudwatchAgent_memoryMonitoring"</span>: <span class="number">23</span>,
  <span class="string">"cloudwatchAgent_diskMonitoring"</span>: <span class="number">23</span>,
  <span class="string">"cloudwatchAgent_percentageWithMemory"</span>: <span class="number">64</span>,
  
  <span class="comment">// SSM Agent</span>
  <span class="string">"ssmAgent_connected"</span>: <span class="number">30</span>,
  <span class="string">"ssmAgent_percentageConnected"</span>: <span class="number">83</span>
}</code></pre>
            </div>

            <!-- Se√ß√£o 7: Boas Pr√°ticas -->
            <div class="page-break"></div>

            <h2 id="best-practices">7. Boas Pr√°ticas e Otimiza√ß√µes üéØ</h2>

            <h3>7.1 Gerenciamento de Mem√≥ria</h3>

            <div class="warning-box">
                <p><strong>Lambda tem limite de mem√≥ria!</strong> Configuramos 3GB, mas precisamos ser eficientes.</p>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Pr√°tica</th>
                        <th>‚ùå Errado</th>
                        <th>‚úÖ Correto</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Pagina√ß√£o</strong></td>
                        <td>Carregar todos os recursos de uma vez</td>
                        <td>Usar paginadores com PageSize adequado</td>
                    </tr>
                    <tr>
                        <td><strong>Processamento</strong></td>
                        <td>Acumular todos os items na mem√≥ria</td>
                        <td>Processar e salvar em batches</td>
                    </tr>
                    <tr>
                        <td><strong>Vari√°veis globais</strong></td>
                        <td>Criar novos clients a cada chamada</td>
                        <td>Reusar clients quando poss√≠vel</td>
                    </tr>
                </tbody>
            </table>

            <h3>7.2 Otimiza√ß√£o de API Calls</h3>

            <div class="code-container">
                <div class="code-header"># T√©cnicas de otimiza√ß√£o</div>
                <pre><code><span class="comment"># 1. Batch operations sempre que poss√≠vel</span>
<span class="keyword">def</span> <span class="function">get_instance_details_batch</span>(ec2, instance_ids):
    <span class="comment"># Em vez de chamar describe_instances para cada ID...</span>
    <span class="comment"># Chama uma vez com m√∫ltiplos IDs</span>
    response = ec2.describe_instances(
        InstanceIds=instance_ids  <span class="comment"># Lista de at√© 1000 IDs</span>
    )

<span class="comment"># 2. Cache de informa√ß√µes que n√£o mudam</span>
<span class="keyword">class</span> <span class="function">ComputeCollector</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(self):
        self._ami_cache = {}  <span class="comment"># Cache de AMI names</span>
    
    <span class="keyword">def</span> <span class="function">get_ami_name</span>(self, ami_id):
        <span class="keyword">if</span> ami_id <span class="keyword">not</span> <span class="keyword">in</span> self._ami_cache:
            <span class="comment"># Busca apenas se n√£o estiver em cache</span>
            self._ami_cache[ami_id] = self._fetch_ami_name(ami_id)
        <span class="keyword">return</span> self._ami_cache[ami_id]

<span class="comment"># 3. Paraleliza√ß√£o com ThreadPoolExecutor</span>
<span class="keyword">with</span> ThreadPoolExecutor(max_workers=<span class="number">10</span>) <span class="keyword">as</span> executor:
    futures = []
    <span class="keyword">for</span> region <span class="keyword">in</span> regions:
        <span class="comment"># Processa regi√µes em paralelo</span>
        future = executor.submit(process_region, region)
        futures.append(future)</code></pre>
            </div>

            <h3>7.3 Tratamento de Erros</h3>

            <div class="code-container">
                <div class="code-header"># Padr√£o de retry com backoff</div>
                <pre><code><span class="keyword">from</span> botocore.config <span class="keyword">import</span> Config

<span class="comment"># Configura√ß√£o de retry autom√°tico</span>
BOTO3_CONFIG = Config(
    retries={
        <span class="string">'max_attempts'</span>: <span class="number">5</span>,           <span class="comment"># M√°ximo de tentativas</span>
        <span class="string">'mode'</span>: <span class="string">'adaptive'</span>            <span class="comment"># Modo adaptativo</span>
    },
    connect_timeout=<span class="number">10</span>,                <span class="comment"># Timeout de conex√£o</span>
    read_timeout=<span class="number">60</span>,                   <span class="comment"># Timeout de leitura</span>
    max_pool_connections=<span class="number">50</span>            <span class="comment"># Pool de conex√µes</span>
)

<span class="comment"># Tratamento espec√≠fico de throttling</span>
<span class="keyword">def</span> <span class="function">safe_api_call</span>(func, *args, **kwargs):
    max_retries = <span class="number">5</span>
    <span class="keyword">for</span> attempt <span class="keyword">in</span> range(max_retries):
        <span class="keyword">try</span>:
            <span class="keyword">return</span> func(*args, **kwargs)
        <span class="keyword">except</span> ClientError <span class="keyword">as</span> e:
            error_code = e.response[<span class="string">'Error'</span>][<span class="string">'Code'</span>]
            
            <span class="keyword">if</span> error_code == <span class="string">'ThrottlingException'</span>:
                <span class="comment"># Backoff exponencial para throttling</span>
                wait_time = <span class="number">2</span> ** attempt
                logger.warning(<span class="string">f"Throttled, waiting </span>{wait_time}<span class="string">s"</span>)
                time.sleep(wait_time)
            <span class="keyword">else</span>:
                <span class="keyword">raise</span>  <span class="comment"># Re-raise se n√£o for throttling</span></code></pre>
            </div>

            <h3>7.4 Monitoramento de Tempo</h3>

            <div class="info-box">
                <p><strong>Lambda tem timeout de 15 minutos!</strong> Precisamos monitorar o tempo restante.</p>
            </div>

            <div class="code-container">
                <div class="code-header"># Monitoramento de tempo de execu√ß√£o</div>
                <pre><code><span class="keyword">def</span> <span class="function">lambda_handler</span>(event, context):
    <span class="comment"># Context fornece m√©todo para verificar tempo restante</span>
    
    <span class="keyword">for</span> account <span class="keyword">in</span> accounts:
        <span class="comment"># Verifica tempo antes de processar pr√≥xima conta</span>
        remaining_ms = context.get_remaining_time_in_millis()
        
        <span class="keyword">if</span> remaining_ms < <span class="number">30000</span>:  <span class="comment"># Menos de 30 segundos</span>
            logger.warning(<span class="string">"Approaching timeout, stopping"</span>)
            <span class="comment"># Salva m√©tricas parciais e encerra gracefully</span>
            save_partial_metrics()
            <span class="keyword">break</span>
        
        <span class="comment"># Processa conta se h√° tempo suficiente</span>
        process_account(account)</code></pre>
            </div>

            <!-- Se√ß√£o 8: Troubleshooting -->
            <div class="page-break"></div>

            <h2 id="troubleshooting">8. Troubleshooting e Monitoramento üîç</h2>

            <h3>8.1 CloudWatch Logs</h3>

            <p>Todas as execu√ß√µes da Lambda s√£o logadas no CloudWatch. Estrutura dos logs:</p>

            <div class="code-container">
                <div class="code-header"># Estrutura de logs</div>
                <pre><code><span class="comment"># Log Group</span>
/aws/lambda/OneVisionResourceCollector

<span class="comment"># Log Stream (um por execu√ß√£o)</span>
2025/09/19/[$LATEST]a1b2c3d4e5f6g7h8

<span class="comment"># Formato dos logs</span>
[INFO] 2025-09-19T10:00:00.123Z - Starting collection for account Production (123456789)
[INFO] 2025-09-19T10:00:01.456Z - Found 5 enabled regions
[INFO] 2025-09-19T10:00:02.789Z - Processing region us-east-1
[DEBUG] 2025-09-19T10:00:03.012Z - Found 152 EC2 instances
[WARNING] 2025-09-19T10:00:04.345Z - Throttling detected, backing off
[ERROR] 2025-09-19T10:00:05.678Z - Failed to assume role in account 987654321</code></pre>
            </div>

            <h3>8.2 M√©tricas CloudWatch</h3>

            <table>
                <thead>
                    <tr>
                        <th>M√©trica</th>
                        <th>O que monitora</th>
                        <th>Valor de alerta</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Duration</strong></td>
                        <td>Tempo de execu√ß√£o</td>
                        <td>> 840000 ms (14 min)</td>
                    </tr>
                    <tr>
                        <td><strong>Errors</strong></td>
                        <td>Execu√ß√µes com erro</td>
                        <td>> 0</td>
                    </tr>
                    <tr>
                        <td><strong>Throttles</strong></td>
                        <td>Execu√ß√µes throttled</td>
                        <td>> 0</td>
                    </tr>
                    <tr>
                        <td><strong>ConcurrentExecutions</strong></td>
                        <td>Execu√ß√µes simult√¢neas</td>
                        <td>> 900</td>
                    </tr>
                    <tr>
                        <td><strong>IteratorAge</strong></td>
                        <td>Idade do stream (se usar Kinesis)</td>
                        <td>> 60000 ms</td>
                    </tr>
                </tbody>
            </table>

            <h3>8.3 Problemas Comuns e Solu√ß√µes</h3>

            <h4>‚ùå Problema: "Task timed out after 900.00 seconds"</h4>
            <div class="info-box">
                <p><strong>Causa:</strong> Lambda atingiu o timeout de 15 minutos.</p>
                <p><strong>Solu√ß√£o:</strong></p>
                <ul style="margin: 10px 0; padding-left: 30px;">
                    <li>Reduzir n√∫mero de contas processadas por execu√ß√£o</li>
                    <li>Aumentar paraleliza√ß√£o (mais workers)</li>
                    <li>Otimizar queries do DynamoDB</li>
                    <li>Implementar checkpoint para continuar de onde parou</li>
                </ul>
            </div>

            <h4>‚ùå Problema: "Unable to assume role"</h4>
            <div class="info-box">
                <p><strong>Causa:</strong> Role OneVisionDataCollectorRole n√£o existe ou sem trust relationship.</p>
                <p><strong>Solu√ß√£o:</strong></p>
                <ul style="margin: 10px 0; padding-left: 30px;">
                    <li>Verificar se a role existe na conta destino</li>
                    <li>Verificar trust relationship permite a conta da Lambda</li>
                    <li>Verificar se n√£o h√° SCP (Service Control Policy) bloqueando</li>
                </ul>
            </div>

            <h4>‚ùå Problema: "ProvisionedThroughputExceededException"</h4>
            <div class="info-box">
                <p><strong>Causa:</strong> DynamoDB throttling por exceder capacidade.</p>
                <p><strong>Solu√ß√£o:</strong></p>
                <ul style="margin: 10px 0; padding-left: 30px;">
                    <li>Habilitar Auto Scaling no DynamoDB</li>
                    <li>Aumentar capacidade provisionada temporariamente</li>
                    <li>Implementar retry com backoff exponencial</li>
                    <li>Distribuir writes ao longo do tempo</li>
                </ul>
            </div>

            <h3>8.4 Dashboard de Monitoramento</h3>

            <div class="highlight-box">
                <p><strong>Crie um CloudWatch Dashboard</strong> com os seguintes widgets para monitorar a sa√∫de do OneVision:</p>
            </div>

            <div class="code-container">
                <div class="code-header"># Queries √∫teis para CloudWatch Insights</div>
                <pre><code><span class="comment"># 1. Contas processadas por execu√ß√£o</span>
fields @timestamp, @message
| filter @message like /Processing account/
| stats count() by bin(5m)

<span class="comment"># 2. Recursos coletados por tipo</span>
fields @timestamp, @message
| parse @message "Added * * from region" as count, resourceType
| stats sum(count) by resourceType

<span class="comment"># 3. Tempo de processamento por conta</span>
fields @timestamp, account, duration
| parse @message "Account * processing time: * seconds" as account, duration
| sort duration desc

<span class="comment"># 4. Erros por tipo</span>
fields @timestamp, @message
| filter @type = "ERROR"
| parse @message "Error * :" as errorType
| stats count() by errorType</code></pre>
            </div>

            <h3>8.5 Alertas Recomendados</h3>

            <table>
                <thead>
                    <tr>
                        <th>Alerta</th>
                        <th>Condi√ß√£o</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Falha na Coleta</strong></td>
                        <td>Errors > 0 por 2 per√≠odos</td>
                        <td>Email para time de DevOps</td>
                    </tr>
                    <tr>
                        <td><strong>Dura√ß√£o Alta</strong></td>
                        <td>Duration > 12 minutos</td>
                        <td>Investigar otimiza√ß√µes</td>
                    </tr>
                    <tr>
                        <td><strong>Throttling DynamoDB</strong></td>
                        <td>UserErrors > 10 em 5 min</td>
                        <td>Aumentar capacidade</td>
                    </tr>
                    <tr>
                        <td><strong>Dados Desatualizados</strong></td>
                        <td>√öltima execu√ß√£o > 8 horas</td>
                        <td>Verificar EventBridge</td>
                    </tr>
                </tbody>
            </table>

            <!-- Conclus√£o -->
            <div class="page-break"></div>

            <h2>üéì Conclus√£o</h2>

            <div class="highlight-box">
                <p><strong>Parab√©ns!</strong> Voc√™ agora entende como as Lambda Functions funcionam no OneVision! üéâ</p>
            </div>

            <h3>Resumo do Aprendizado</h3>

            <p>Neste guia, voc√™ aprendeu:</p>

            <div class="feature-grid">
                <div class="feature-card">
                    <div class="feature-icon">‚úÖ</div>
                    <div class="feature-title">Lambda Basics</div>
                    <div class="feature-description">O que √© Lambda, serverless, e suas caracter√≠sticas principais</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚úÖ</div>
                    <div class="feature-title">Arquitetura OneVision</div>
                    <div class="feature-description">Como Lambda se integra no ecossistema OneVision</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚úÖ</div>
                    <div class="feature-title">Fluxo de Coleta</div>
                    <div class="feature-description">AssumeRole ‚Üí Collect ‚Üí Process ‚Üí Save</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚úÖ</div>
                    <div class="feature-title">C√≥digo Python</div>
                    <div class="feature-description">An√°lise detalhada dos collectors</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚úÖ</div>
                    <div class="feature-title">DynamoDB</div>
                    <div class="feature-description">Estrutura de dados e campos</div>
                </div>
                <div class="feature-card">
                    <div class="feature-icon">‚úÖ</div>
                    <div class="feature-title">Best Practices</div>
                    <div class="feature-description">Otimiza√ß√µes e padr√µes</div>
                </div>
            </div>

            <h3>Pr√≥ximos Passos</h3>

            <ol style="margin: 20px 0; padding-left: 30px; line-height: 2;">
                <li><strong>Pratique:</strong> Deploy uma Lambda simples no seu ambiente de desenvolvimento</li>
                <li><strong>Explore:</strong> Analise os logs no CloudWatch de execu√ß√µes reais</li>
                <li><strong>Contribua:</strong> Adicione um novo tipo de recurso ao coletor</li>
                <li><strong>Otimize:</strong> Identifique e implemente uma melhoria de performance</li>
                <li><strong>Monitore:</strong> Crie seu pr√≥prio dashboard de monitoramento</li>
            </ol>

            <h3>Recursos Adicionais</h3>

            <table>
                <thead>
                    <tr>
                        <th>Recurso</th>
                        <th>Link</th>
                        <th>Descri√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>AWS Lambda Docs</strong></td>
                        <td>docs.aws.amazon.com/lambda</td>
                        <td>Documenta√ß√£o oficial</td>
                    </tr>
                    <tr>
                        <td><strong>Boto3 Documentation</strong></td>
                        <td>boto3.amazonaws.com/v1/documentation</td>
                        <td>SDK Python para AWS</td>
                    </tr>
                    <tr>
                        <td><strong>DynamoDB Best Practices</strong></td>
                        <td>docs.aws.amazon.com/amazondynamodb/latest/developerguide</td>
                        <td>Guia de boas pr√°ticas</td>
                    </tr>
                    <tr>
                        <td><strong>CloudWatch Insights</strong></td>
                        <td>docs.aws.amazon.com/AmazonCloudWatch/latest/logs</td>
                        <td>An√°lise de logs</td>
                    </tr>
                </tbody>
            </table>

            <div class="info-box" style="margin-top: 40px; text-align: center;">
                <h3>üöÄ Boa sorte na sua jornada com AWS Lambda e OneVision!</h3>
                <p>Lembre-se: a pr√°tica leva √† perfei√ß√£o. N√£o tenha medo de experimentar e errar - √© assim que aprendemos!</p>
            </div>

            <div style="text-align: center; margin-top: 50px; padding-top: 30px; border-top: 2px solid #e2e8f0;">
                <p style="color: #718096; font-size: 0.9em;">
                    Guia AWS Lambda Functions - OneVision<br>
                    Vers√£o 1.0 - Setembro 2025<br>
                    Desenvolvido com üíú para a equipe de desenvolvimento
                </p>
            </div>
        </div>
    </div>
</body>
</html>