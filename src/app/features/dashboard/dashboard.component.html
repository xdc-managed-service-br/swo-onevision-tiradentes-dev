<!-- src/app/features/dashboard/dashboard.component.html -->
<article class="ov-container" aria-labelledby="dashboard-title">
  <div class="ov-header-with-actions">
    <h1 id="dashboard-title" class="ov-title">Dashboard</h1>
    <div class="ov-actions">
      <!-- Metrics Status Indicator -->
      <div class="metrics-status" *ngIf="!loading">
        <span class="status-indicator" [class.stale]="isMetricsStale()">
          <span class="status-dot"></span>
          <span class="status-text">
            Last updated: {{ getTimeSinceCollection() }}
            <span *ngIf="collectionDuration" class="duration">
              ({{ formatDuration(collectionDuration) }})
            </span>
          </span>
        </span>
        <button
          class="ov-btn ov-btn--subtle"
          (click)="refreshMetrics()"
          [disabled]="loading"
          aria-label="Refresh metrics">
          <span>‚Üª</span> Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="ov-loading">
    <div class="ov-loading-spinner"></div>
    <p>Loading dashboard metrics...</p>
    <small>Fetching pre-calculated metrics from DynamoDB</small>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="ov-alert ov-alert--danger">
    <strong>Error loading metrics</strong>
    <p>{{ error }}</p>
    <button class="ov-btn ov-btn--primary" (click)="refreshMetrics()">Try Again</button>
  </div>

  <!-- Metrics Warning if Stale -->
  <div *ngIf="!loading && !error && isMetricsStale()" class="ov-alert ov-alert--warning">
    <strong>Metrics may be outdated</strong>
    <p>The last data collection was more than 24 hours ago. Consider running the Lambda function to update metrics.</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading && !error" class="db-grid">

    <!-- 1) Resource Summary Cards -->
    <section class="db-stats" aria-label="Resource summary">
      <!-- DO NOT TOUCH: All Resources card (requested) -->
      <div class="db-stat" [attr.aria-label]="'Total resources: ' + totalResources">
        <span class="db-stat__value">{{ totalResources || 0 }}</span>
        <span class="db-stat__label">All Resources</span>
      </div>

      <a class="db-stat" [routerLink]="['/resources/ec2']" [attr.aria-label]="'EC2 Instances: ' + ( resourceCounts_EC2Instance || 0)">
        <span class="db-stat__value">{{ resourceCounts_EC2Instance || 0 }}</span>
        <span class="db-stat__label">EC2 Instances</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/rds']" [attr.aria-label]="'RDS Instances: ' + (resourceCounts_RDSInstance || 0)">
        <span class="db-stat__value">{{ resourceCounts_RDSInstance || 0 }}</span>
        <span class="db-stat__label">RDS Instances</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/s3']" [attr.aria-label]="'S3 Buckets: ' + (resourceCounts_S3Bucket || 0)">
        <span class="db-stat__value">{{ resourceCounts_S3Bucket || 0 }}</span>
        <span class="db-stat__label">S3 Buckets</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/ebs']" [attr.aria-label]="'EBS Volumes: ' + (resourceCounts_EBSVolume || 0)">
        <span class="db-stat__value">{{ resourceCounts_EBSVolume || 0 }}</span>
        <span class="db-stat__label">EBS Volumes</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/vpc']" [attr.aria-label]="'VPCs: ' + (resourceCounts_VPC || 0)">
        <span class="db-stat__value">{{ resourceCounts_VPC || 0 }}</span>
        <span class="db-stat__label">VPCs</span>
      </a>
    </section>

    <!-- 2) Cost Optimization Alert (if savings available) -->
    <section *ngIf="costSavings > 0" class="db-section">
      <div class="ov-alert ov-alert--info">
        <h3>üí∞ Cost Optimization Opportunity</h3>
        <p>
          Potential monthly savings: <strong>${{ costSavings | number:'1.2-2' }}</strong>
        </p>
        <ul *ngIf="unattachedVolumes > 0 || unassociatedElasticIPs > 0">
          <li *ngIf="unattachedVolumes > 0">{{ unattachedVolumes }} unattached EBS volumes</li>
          <li *ngIf="unassociatedElasticIPs > 0">{{ unassociatedElasticIPs }} unassociated Elastic IPs</li>
        </ul>
      </div>
    </section>

    <!-- 3) EC2 Instance Status -->
    <section class="db-section">
      <div class="db-monitoring">
        <h3 class="db-h3">EC2 Instance Status</h3>
        <div class="db-status-grid">
          <div class="db-status-item">
            <span class="db-status-value">{{ ec2Health.total || 0 }}</span>
            <span class="db-status-label">Total</span>
          </div>
          <div class="db-status-item status-running">
            <span class="db-status-value">{{ ec2Health.running || 0 }}</span>
            <span class="db-status-label">Running</span>
          </div>
          <div class="db-status-item status-stopped">
            <span class="db-status-value">{{ ec2Health.stopped || 0 }}</span>
            <span class="db-status-label">Stopped</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 4) Monitoring Status -->
    <section class="db-section">
      <div class="db-monitoring">
        <h3 class="db-h3">Monitoring Status</h3>
        <div class="db-monitoring-grid">
          <!-- RAM Monitoring -->
          <div class="db-monitoring-card">
            <h4>RAM Monitoring</h4>
            <div class="db-progress">
              <div class="db-progress-bar" [style.width.%]="ramMonitoredPercentage || 0"></div>
            </div>
            <p class="db-progress-text">{{ ramMonitoredPercentage || 0 }}% of running instances</p>
          </div>

          <!-- Disk Monitoring -->
          <div class="db-monitoring-card">
            <h4>Disk Monitoring</h4>
            <div class="db-progress">
              <div class="db-progress-bar" [style.width.%]="diskMonitoredPercentage || 0"></div>
            </div>
            <p class="db-progress-text">{{ diskMonitoredPercentage || 0 }}% of running instances</p>
          </div>

          <!-- SSM Agent -->
          <div class="db-monitoring-card">
            <h4>SSM Agent</h4>
            <div class="db-progress">
              <div class="db-progress-bar" [style.width.%]="ssmConnectedPercentage || 0"></div>
            </div>
            <p class="db-progress-text">{{ ec2Health.ssmConnected || 0 }} of {{ ec2Health.running || 0 }} connected</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 5) Security Alert (if exposed security groups) -->
    <section *ngIf="exposedSecurityGroups > 0" class="db-section">
      <div class="ov-alert ov-alert--warning">
        <h3>‚ö†Ô∏è Security Review Needed</h3>
        <p>
          <strong>{{ exposedSecurityGroups }}</strong> of {{ resourceCounts_SecurityGroup || 0 }} security groups
          have ports exposed to the internet (0.0.0.0/0).
        </p>
        <a [routerLink]="['/resources/security-groups']" class="ov-btn ov-btn--primary">
          Review Security Groups
        </a>
      </div>
    </section>

    <!-- 6) Distribution Charts -->
    <section class="db-widgets">
      <!-- Resources by Account -->
      <div class="db-widget" *ngIf="accountDistribution.length > 0">
        <div class="db-widget__head">
          <h3 class="db-h3">Resources by Account</h3>
        </div>
        <div class="db-widget__body">
          <div class="db-bars">
            <div *ngFor="let item of accountDistribution; "
                 class="db-bar"
                 [attr.aria-label]="item.account + ': ' + item.count">
              <div class="db-bar__label" [title]="item.account">
                {{ item.account }}
              </div>
              <div class="db-bar__track">
                <div class="db-bar__fill" [style.width.%]="getBarWidth(item.count, accountMaxCount)">
                  <span class="db-bar__value">{{ item.count }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Resources by Region -->
      <div class="db-widget" *ngIf="regionDistribution.length > 0">
        <div class="db-widget__head">
          <h3 class="db-h3">Resources by Region</h3>
        </div>
        <div class="db-widget__body">
          <div class="db-bars">
            <div *ngFor="let item of regionDistribution; "
                 class="db-bar"
                 [attr.aria-label]="item.region + ': ' + item.count">
              <div class="db-bar__label" [title]="item.region">{{ item.region }}</div>
              <div class="db-bar__track">
                <div class="db-bar__fill" [style.width.%]="getBarWidth(item.count, regionMaxCount)">
                  <span class="db-bar__value">{{ item.count }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</article>
