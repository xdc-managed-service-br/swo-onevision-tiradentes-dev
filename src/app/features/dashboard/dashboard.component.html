<!-- src/app/features/dashboard/dashboard.component.html -->
<article class="ov-container" aria-labelledby="dashboard-title">
  <div class="ov-header-with-actions">
    <h1 id="dashboard-title" class="ov-title">Dashboard</h1>
    <div class="ov-actions">
      <!-- Metrics Status Indicator -->
      <div class="metrics-status" *ngIf="!loading">
        <span class="status-indicator" [class.stale]="metricsStale">
          <span class="status-dot"></span>
          <span class="status-text">
            Last updated: {{ getTimeSinceCollection() }}
            <span *ngIf="collectionDuration" class="duration">
              ({{ formatDuration(collectionDuration) }})
            </span>
          </span>
        </span>
        <button 
          class="ov-btn ov-btn--subtle" 
          (click)="refreshMetrics()"
          [disabled]="loading"
          aria-label="Refresh metrics">
          <span>‚Üª</span> Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="ov-loading">
    <div class="ov-loading-spinner"></div>
    <p>Loading optimized metrics...</p>
    <small>This should take less than a second</small>
  </div>

  <!-- Metrics Warning if Stale -->
  <div *ngIf="!loading && metricsStale" class="ov-alert ov-alert--warning">
    <strong>Metrics may be outdated</strong>
    <p>The last data collection was more than 24 hours ago. Consider running the Lambda function to update metrics.</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading" class="db-grid">

    <!-- 1) Resource Summary Cards -->
    <section class="db-stats" aria-label="Resource summary">
      <a class="db-stat is-total" [routerLink]="['/resources']" [attr.aria-label]="'Total resources: ' + resourceCounts.total">
        <span class="db-stat__value">{{ resourceCounts.total | number }}</span>
        <span class="db-stat__label">Total Resources</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/ec2']" [attr.aria-label]="'EC2 Instances: ' + resourceCounts.ec2">
        <span class="db-stat__value">{{ resourceCounts.ec2 | number }}</span>
        <span class="db-stat__label">EC2 Instances</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/rds']" [attr.aria-label]="'RDS Instances: ' + resourceCounts.rds">
        <span class="db-stat__value">{{ resourceCounts.rds | number }}</span>
        <span class="db-stat__label">RDS Instances</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/s3']" [attr.aria-label]="'S3 Buckets: ' + resourceCounts.s3">
        <span class="db-stat__value">{{ resourceCounts.s3 | number }}</span>
        <span class="db-stat__label">S3 Buckets</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/ebs']" [attr.aria-label]="'EBS Volumes: ' + resourceCounts.ebs">
        <span class="db-stat__value">{{ resourceCounts.ebs | number }}</span>
        <span class="db-stat__label">EBS Volumes</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/ebs-snapshots']" [attr.aria-label]="'EBS Snapshots: ' + resourceCounts.ebsSnapshots">
        <span class="db-stat__value">{{ resourceCounts.ebsSnapshots | number }}</span>
        <span class="db-stat__label">EBS Snapshots</span>
      </a>

      <a class="db-stat" [routerLink]="['/resources/ami-snapshots']" [attr.aria-label]="'AMI Snapshots: ' + resourceCounts.amiSnapshots">
        <span class="db-stat__value">{{ resourceCounts.amiSnapshots | number }}</span>
        <span class="db-stat__label">AMI Snapshots</span>
      </a>
    </section>

    <!-- 2) Cost Optimization Alert (if savings available) -->
    <section *ngIf="costSavings > 0" class="db-section">
      <div class="ov-alert ov-alert--info">
        <h3>üí∞ Cost Optimization Opportunity</h3>
        <p>
          Potential monthly savings: <strong>${{ costSavings | number:'1.2-2' }}</strong>
        </p>
        <ul>
          <li *ngIf="unattachedVolumes > 0">
            {{ unattachedVolumes }} unattached EBS volumes
          </li>
          <li *ngIf="unassociatedEIPs > 0">
            {{ unassociatedEIPs }} unassociated Elastic IPs
          </li>
        </ul>
      </div>
    </section>

    <!-- 3) Resource Health (still uses component, but could be optimized too) -->
    <section class="db-section">
      <app-resource-health></app-resource-health>
    </section>

    <!-- 4) Monitoring / Status Section -->
    <section class="db-section">
      <div class="db-monitoring">
        <!-- CloudWatch Monitoring -->
        <div class="db-monitoring__block">
          <h3 class="db-h3">Resource Monitoring (CloudWatch)</h3>
          <div class="db-monitoring__grid">
            <app-monitoring-widget
              title="RAM Monitoring"
              [percentage]="monitoringStatus.ramMonitoredPercentage"
              label="Active on Running Instances"
              color="#4fd1c5">
            </app-monitoring-widget>

            <app-monitoring-widget
              title="Disk Monitoring"
              [percentage]="monitoringStatus.diskMonitoredPercentage"
              label="Active on Running Instances"
              color="#9f7aea">
            </app-monitoring-widget>
          </div>
        </div>

        <!-- Instance Status -->
        <div class="db-monitoring__block">
          <h3 class="db-h3">Instance Status</h3>
          <app-instance-status-widget
            [total]="instanceStatus.total"
            [running]="instanceStatus.running"
            [stopped]="instanceStatus.stopped"
            [pending]="instanceStatus.pending"
            [terminated]="instanceStatus.terminated">
          </app-instance-status-widget>
        </div>

        <!-- SSM Agent Status -->
        <div class="db-monitoring__block">
          <h3 class="db-h3">SSM Agent Status</h3>
          <app-monitoring-widget
            title="SSM Agent"
            [percentage]="ssmStatus.connectedPercentage"
            [label]="ssmStatus.connected + ' of ' + ssmStatus.total + ' running instances'"
            color="#68d391">
          </app-monitoring-widget>
        </div>
      </div>
    </section>

    <!-- 5) Security Alert (if exposed security groups) -->
    <section *ngIf="exposedSecurityGroups > 0" class="db-section">
      <div class="ov-alert ov-alert--warning">
        <h3>‚ö†Ô∏è Security Review Needed</h3>
        <p>
          <strong>{{ exposedSecurityGroups }}</strong> of {{ totalSecurityGroups }} security groups 
          have ports exposed to the internet (0.0.0.0/0).
        </p>
        <a [routerLink]="['/resources/security-groups']" class="ov-btn ov-btn--primary">
          Review Security Groups
        </a>
      </div>
    </section>

    <!-- 6) Distribution Widgets -->
    <section class="db-widgets">

      <!-- Resources by Account -->
      <div class="db-widget">
        <div class="db-widget__head">
          <h3 class="db-h3">Resources by Account</h3>
        </div>
        <div class="db-widget__body">
          <div *ngIf="accountDistribution.length > 0; else noAccountData" class="db-bars">
            <div *ngFor="let item of accountDistribution; trackBy: trackByAccount" 
                 class="db-bar" 
                 [attr.aria-label]="item.accountName + ': ' + item.count">
              <div class="db-bar__label" [title]="item.accountName">
                {{ item.accountName || item.account }}
              </div>
              <div class="db-bar__track">
                <div class="db-bar__fill" [style.width.%]="getBarWidth(item.count, accountMaxCount)">
                  <span class="db-bar__value">{{ item.count | number }}</span>
                </div>
              </div>
            </div>
          </div>
          <ng-template #noAccountData>
            <div class="ov-empty">No account distribution data available</div>
          </ng-template>
        </div>
      </div>

      <!-- Resources by Region -->
      <div class="db-widget">
        <div class="db-widget__head">
          <h3 class="db-h3">Resources by Region</h3>
        </div>
        <div class="db-widget__body">
          <div *ngIf="regionDistribution.length > 0; else noRegionData" class="db-bars">
            <div *ngFor="let item of regionDistribution; trackBy: trackByRegion" 
                 class="db-bar" 
                 [attr.aria-label]="item.region + ': ' + item.count">
              <div class="db-bar__label" [title]="item.region">{{ item.region }}</div>
              <div class="db-bar__track">
                <div class="db-bar__fill" [style.width.%]="getBarWidth(item.count, regionMaxCount)">
                  <span class="db-bar__value">{{ item.count | number }}</span>
                </div>
              </div>
            </div>
          </div>
          <ng-template #noRegionData>
            <div class="ov-empty">No region distribution data available</div>
          </ng-template>
        </div>
      </div>

      <!-- Recent Resources -->
      <div class="db-widget">
        <div class="db-widget__head">
          <h3 class="db-h3">Recent Resources</h3>
          <a class="ov-btn ov-btn--subtle" [routerLink]="['/resources']">View All</a>
        </div>
        <div class="db-widget__body">
          <div *ngIf="recentResources.length > 0; else noRecentData">
            <!-- Desktop: table -->
            <section class="ov-tablewrap db-hide-mobile">
              <table class="ov-table" role="table" aria-label="Recent resources">
                <thead>
                  <tr>
                    <th>Type</th>
                    <th>Region</th>
                    <th>Identifier</th>
                    <th>Last Updated</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let resource of recentResources; trackBy: trackByResourceId" 
                      [routerLink]="['/resources']" 
                      class="db-rowlink"
                      [attr.aria-label]="'View ' + resource.resourceType + ' details'">
                    <td>
                      <span class="resource-type-badge">{{ resource.resourceType }}</span>
                    </td>
                    <td>{{ resource.region || 'global' }}</td>
                    <td>
                      <span class="resource-identifier" [title]="resource.identifier">
                        {{ resource.identifier }}
                      </span>
                    </td>
                    <td>
                      <time [dateTime]="resource.lastUpdated">
                        {{ resource.lastUpdated | date: 'short' }}
                      </time>
                    </td>
                  </tr>
                </tbody>
              </table>
            </section>

            <!-- Mobile: cards -->
            <div class="ov-cards db-show-mobile">
              <article class="ov-card" 
                       *ngFor="let resource of recentResources; trackBy: trackByResourceId" 
                       [routerLink]="['/resources']" 
                       class="db-rowlink"
                       [attr.aria-label]="'View ' + resource.resourceType + ' details'">
                <header class="ov-card__head">
                  <div>
                    <div class="ov-card__title">{{ resource.resourceType }}</div>
                    <div class="ov-card__sub">{{ resource.identifier }}</div>
                  </div>
                </header>
                <div class="ov-card__grid">
                  <div>
                    <div class="ov-k">Region</div>
                    <div class="ov-v">{{ resource.region || 'global' }}</div>
                  </div>
                  <div>
                    <div class="ov-k">Last Updated</div>
                    <div class="ov-v">
                      <time [dateTime]="resource.lastUpdated">
                        {{ resource.lastUpdated | date: 'short' }}
                      </time>
                    </div>
                  </div>
                </div>
              </article>
            </div>
          </div>

          <ng-template #noRecentData>
            <div class="ov-empty">
              <div class="ov-empty__icon">üìÑ</div>
              <p class="ov-empty__text">No recent resources found</p>
              <p class="ov-empty__sub">Resources will appear here after the next collection</p>
            </div>
          </ng-template>
        </div>
      </div>

    </section>
  </div>
</article>